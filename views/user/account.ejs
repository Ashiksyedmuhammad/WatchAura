<%- include('../user-layouts/header.ejs') %>
    <link rel="stylesheet" href="/assets/userCss.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf/notyf.min.css">
    <style>
        /* Container styles for the form */
        .show-form-address {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .grid-2-lg {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .box-field {
            margin-bottom: 20px;
        }

        .tf-field {
            position: relative;
            margin-bottom: 10px;
        }

        .tf-field-input {
            width: 100%;
            padding: 10px 15px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            transition: border 0.3s ease;
        }

        .tf-field-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .tf-field-label {
            position: absolute;
            top: -10px;
            left: 15px;
            font-size: 0.875rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 0 5px;
            transition: top 0.3s ease, font-size 0.3s ease;
            pointer-events: none;
        }

        .tf-field-input:not(:placeholder-shown)+.tf-field-label,
        .tf-field-input:focus+.tf-field-label {
            top: -20px;
            font-size: 0.75rem;
            color: #007bff;
        }

        /* Styling for the select dropdown */
        .select-custom select {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            transition: border 0.3s ease;
        }

        .select-custom select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid-2-lg {
                grid-template-columns: 1fr;
            }
        }

        .mb_10 {
            margin-bottom: 10px;
        }

        .fw-4 {
            font-weight: 400;
        }

        .text_black-2 {
            color: #333;
        }

        /* Align form fields with sidebar */
        .my-account-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .my-account-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .my-account-nav-item {
            display: block;
            padding: 10px;
            border-radius: 5px;
            color: #333;
            text-decoration: none;
        }
    </style>
    </head>
    <header id="header" class="header-default">
        <div class="px_15 lg-px_40">
            <div class="row wrapper-header align-items-center">
                <div class="col-md-4 col-3 tf-lg-hidden">
                    <a href="#mobileMenu" data-bs-toggle="offcanvas" aria-controls="offcanvasLeft">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 16" fill="none">
                            <path
                                d="M2.00056 2.28571H16.8577C17.1608 2.28571 17.4515 2.16531 17.6658 1.95098C17.8802 1.73665 18.0006 1.44596 18.0006 1.14286C18.0006 0.839753 17.8802 0.549063 17.6658 0.334735C17.4515 0.120408 17.1608 0 16.8577 0H2.00056C1.69745 0 1.40676 0.120408 1.19244 0.334735C0.978109 0.549063 0.857702 0.839753 0.857702 1.14286C0.857702 1.44596 0.978109 1.73665 1.19244 1.95098C1.40676 2.16531 1.69745 2.28571 2.00056 2.28571ZM0.857702 8C0.857702 7.6969 0.978109 7.40621 1.19244 7.19188C1.40676 6.97755 1.69745 6.85714 2.00056 6.85714H22.572C22.8751 6.85714 23.1658 6.97755 23.3801 7.19188C23.5944 7.40621 23.7148 7.6969 23.7148 8C23.7148 8.30311 23.5944 8.59379 23.3801 8.80812C23.1658 9.02245 22.8751 9.14286 22.572 9.14286H2.00056C1.69745 9.14286 1.40676 9.02245 1.19244 8.80812C0.978109 8.59379 0.857702 8.30311 0.857702 8ZM0.857702 14.8571C0.857702 14.554 0.978109 14.2633 1.19244 14.049C1.40676 13.8347 1.69745 13.7143 2.00056 13.7143H12.2863C12.5894 13.7143 12.8801 13.8347 13.0944 14.049C13.3087 14.2633 13.4291 14.554 13.4291 14.8571C13.4291 15.1602 13.3087 15.4509 13.0944 15.6653C12.8801 15.8796 12.5894 16 12.2863 16H2.00056C1.69745 16 1.40676 15.8796 1.19244 15.6653C0.978109 15.4509 0.857702 15.1602 0.857702 14.8571Z"
                                fill="currentColor"></path>
                        </svg>
                    </a>
                </div>
                <div class="col-xl-3 col-md-4 col-6">
                    <a href="index.html" class="logo-header">
                        <img src="assets/images/logo/logo.svg" alt="logo" class="logo">
                    </a>
                </div>
                <div class="col-xl-6 tf-md-hidden">
                    <nav class="box-navigation text-center">
                        <ul class="box-nav-ul d-flex align-items-center justify-content-center gap-30">
                            <li class="menu-item">
                                <a href="/" class="item-link">Home<i class="icon icon-arrow-down"></i></a>
                            </li>
                            <li class="menu-item">
                                <a href="/shop" class="item-link">Shope<i class="icon icon-arrow-down"></i></a>
                            </li>
                            <li class="menu-item">
                                <a href="#" class="item-link">About<i class="icon icon-arrow-down"></i></a>
                            </li>
                            <li class="menu-item">
                                <a href="#" class="item-link">Contact<i class="icon icon-arrow-down"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="col-xl-3 col-md-4 col-3">
                    <ul class="nav-icon d-flex justify-content-end align-items-center gap-20">
                        <!-- Search Icon -->
                        <li class="nav-search">
                            <a href="#canvasSearch" data-bs-toggle="offcanvas" aria-controls="offcanvasLeft"
                                class="nav-icon-item">
                                <i class="icon icon-search"></i>
                            </a>
                        </li>

                        <!-- Conditional for showing Logout and User name if logged in, or Login if not -->
                        <% if(locals.userData){ %>
                            <!-- Show Logout Button -->
                            <li class="nav-logout">
                                <form action="/logout" method="POST" class="nav-icon-item" style="display: inline;">
                                    <button type="submit" class="btn-logout"
                                        style="background: none; border: none; padding: 0; cursor: pointer;">
                                        <i class="icon icon-logout"></i> Logout
                                    </button>
                                </form>
                            </li>

                            <!-- Show User Name -->
                            <li class="nav-user">
                                <p class="mb-0">
                                    <%= locals.userData[0]?.firstName %>
                                </p>
                            </li>
                            <% } else { %>
                                <!-- Show Login Button if not logged in -->
                                <li class="nav-account">
                                    <a href="#login" data-bs-toggle="modal" class="nav-icon-item">
                                        <i class="icon icon-account"></i> Login
                                    </a>
                                </li>
                                <% } %>

                                    <!-- Wishlist Icon -->
                                    <li class="nav-wishlist">
                                        <a href="wishlist.html" class="nav-icon-item">
                                            <i class="icon icon-heart"></i><span class="count-box">0</span>
                                        </a>
                                    </li>

                                    <!-- Cart Icon -->
                                    <li class="nav-cart">
                                        <a href="#shoppingCart" data-bs-toggle="modal" class="nav-icon-item">
                                            <i class="icon icon-bag"></i><span class="count-box">0</span>
                                        </a>
                                    </li>
                    </ul>
                </div>
            </div>
        </div>

    </header>
    <div class="tf-page-title">
        <div class="container-full">
            <div class="heading text-center">Account Details</div>
        </div>
    </div>
    <section class="flat-spacing-11">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <ul class="my-account-nav">
                        <li><a href="/profile" class="my-account-nav-item">Dashboard</a></li>
                        <li><a href="/orders" class="my-account-nav-item">Orders</a></li>
                        <li><a href="/address" class="my-account-nav-item">Address</a></li>
                        <li><a href="/account" class="my-account-nav-item active">Account Details</a></li>
                        <li><a href="my-account-wishlist.html" class="my-account-nav-item">Wishlist</a></li>
                    </ul>
                </div>

                <div class="col-lg-9">
                    <div class="my-account-content account-edit">
                        <form id="form-password-change" action="/update-account" method="POST">
                            <div class="tf-field style-1 mb_15">
                                <input class="tf-field-input tf-input" placeholder=" " type="text" id="name" name="name"
                                    value="<%= userData ? userData.firstName : '' %>">
                                <label class="tf-field-label fw-4 text_black-2" for="name">Name</label>
                            </div>
                            <h6 class="mb_20">Password Change</h6>
                            <div class="tf-field style-1 mb_30">
                                <input class="tf-field-input tf-input" placeholder=" " type="password"
                                    id="currentPassword" name="currentPassword">
                                <label class="tf-field-label fw-4 text_black-2" for="currentPassword">Current
                                    password</label>
                            </div>
                            <div class="tf-field style-1 mb_30">
                                <input class="tf-field-input tf-input" placeholder=" " type="password" id="newPassword"
                                    name="newPassword">
                                <label class="tf-field-label fw-4 text_black-2" for="newPassword">New password</label>
                            </div>
                            <div class="tf-field style-1 mb_30">
                                <input class="tf-field-input tf-input" placeholder=" " type="password"
                                    id="confirmPassword" name="confirmPassword">
                                <label class="tf-field-label fw-4 text_black-2" for="confirmPassword">Confirm
                                    password</label>
                            </div>
                            <div class="mb_20">
                                <button type="submit"
                                    class="tf-btn w-100 radius-3 btn-fill animate-hover-btn justify-content-center">Save
                                    Changes</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf/notyf.min.js"></script>

    <script>
        document.getElementById('form-password-change').addEventListener('submit', async function (e) {
            e.preventDefault(); // Prevent default form submission

            // Get form values
            const name = document.getElementById('name').value.trim();
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            // Initialize Notyf for flash messages
            const notyf = new Notyf({
                duration: 5000, // Duration of the message
                position: { x: 'center', y: 'center' }, // Position of the message
            });
            const nameRegex = /^[a-zA-Z]+(?: [a-zA-Z]+)*$/;
            // Simple validation
            if (!name) {
                notyf.error('Please enter your name');
                return;
            } else if (name.length < 3) {
                notyf.error('Please enter atleast 3 letters');
                return;
            } else if (!nameRegex.test(name)) {
                notyf.error('Name should be contains only letters');
                return;
            }

            if (!currentPassword) {
                notyf.error('Please enter your current password');
                return;
            }
            if (newPassword.length > 1) {

                if (newPassword && newPassword.length < 8) {
                    notyf.error('New password must be atleast 8 characters long');
                    return;
                }


                if (newPassword !== confirmPassword) {
                    notyf.error('New password and confirm password do not match');
                    return;
                }
            }

            // Prepare data for submission
            const formData = {
                name,
                currentPassword,
                newPassword,
                confirmPassword
            };

            try {
                // Submit the form using Fetch API
                const response = await fetch('/update-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    notyf.success('Account updated successfully');
                    // Optionally, reload or redirect to a different page
                    setTimeout(() => window.location.reload(), 1500); // Reload after 1.5 seconds
                } else {
                    notyf.error(result.message);
                }
            } catch (error) {
                console.error('Error submitting the form:', error);
                notyf.error('An error occurred while updating your account');
            }
        });
    </script>
    <%- include('../user-layouts/footer.ejs') %>