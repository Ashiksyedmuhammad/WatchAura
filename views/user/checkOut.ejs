<%- include('../user-layouts/header.ejs') %>



    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .tf-page-cart-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .tf-page-cart-item {
            flex: 1;
            min-width: 300px;
        }

        .tf-page-cart-footer {
            flex: 1;
            min-width: 300px;
        }

        .address-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .edit-address {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #addressForm input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }

        .tf-btn {
            background-color: #000000;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }

        .address-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 250px;
            /* Increased minimum height */
        }

        .address-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .form-check-input:checked+.form-check-label {
            font-weight: bold;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-basis: 50%;
        }

        .btn-edit {
            flex-grow: 0;
            flex-basis: 50%;
            border-bottom-right-radius: 0px;
            border-top-left-radius: 0px;
            border-top-right-radius: 0px;

            border-bottom-left-radius: 0px;
        }

        .btn-delete {
            flex-grow: 0;
            flex-basis: 50%;
            border-bottom-right-radius: 0;
            border-top-left-radius: 0px;
            border-top-right-radius: 0px;
            border-bottom-left-radius: 0px;
        }

        #productCards {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .adrs-btn {
            display: flex;
            justify-content: center;
        }
        .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    </style>

    </head>

    <body class="preload-wrapper">
        <!-- preload -->
        <!-- <div class="preload preload-container">
        <div class="preload-logo">
            <div class="spinner"></div>
        </div>
    </div> -->
        <!-- /preload -->
        <div id="wrapper">
            <!-- Top bar -->
            <div class="tf-top-bar bg_white line">
                <div class="px_15 lg-px_40">

                </div>
            </div>
            <!-- /Top bar -->
            <!-- Header -->
            <header id="header" class="header-default">
                <div class="px_15 lg-px_40">
                    <div class="row wrapper-header align-items-center">
                        <div class="col-md-4 col-3 tf-lg-hidden">
                            <a href="#mobileMenu" data-bs-toggle="offcanvas" aria-controls="offcanvasLeft">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 16"
                                    fill="none">
                                    <path
                                        d="M2.00056 2.28571H16.8577C17.1608 2.28571 17.4515 2.16531 17.6658 1.95098C17.8802 1.73665 18.0006 1.44596 18.0006 1.14286C18.0006 0.839753 17.8802 0.549063 17.6658 0.334735C17.4515 0.120408 17.1608 0 16.8577 0H2.00056C1.69745 0 1.40676 0.120408 1.19244 0.334735C0.978109 0.549063 0.857702 0.839753 0.857702 1.14286C0.857702 1.44596 0.978109 1.73665 1.19244 1.95098C1.40676 2.16531 1.69745 2.28571 2.00056 2.28571ZM0.857702 8C0.857702 7.6969 0.978109 7.40621 1.19244 7.19188C1.40676 6.97755 1.69745 6.85714 2.00056 6.85714H22.572C22.8751 6.85714 23.1658 6.97755 23.3801 7.19188C23.5944 7.40621 23.7148 7.6969 23.7148 8C23.7148 8.30311 23.5944 8.59379 23.3801 8.80812C23.1658 9.02245 22.8751 9.14286 22.572 9.14286H2.00056C1.69745 9.14286 1.40676 9.02245 1.19244 8.80812C0.978109 8.59379 0.857702 8.30311 0.857702 8ZM0.857702 14.8571C0.857702 14.554 0.978109 14.2633 1.19244 14.049C1.40676 13.8347 1.69745 13.7143 2.00056 13.7143H12.2863C12.5894 13.7143 12.8801 13.8347 13.0944 14.049C13.3087 14.2633 13.4291 14.554 13.4291 14.8571C13.4291 15.1602 13.3087 15.4509 13.0944 15.6653C12.8801 15.8796 12.5894 16 12.2863 16H2.00056C1.69745 16 1.40676 15.8796 1.19244 15.6653C0.978109 15.4509 0.857702 15.1602 0.857702 14.8571Z"
                                        fill="currentColor"></path>
                                </svg>
                            </a>
                        </div>
                        <div class="col-xl-3 col-md-4 col-6">
                            <a href="index.html" class="logo-header">
                                <img src="assets/images/logo/logo.svg" alt="logo" class="logo">
                            </a>
                        </div>
                        <div class="col-xl-6 tf-md-hidden">
                            <nav class="box-navigation text-center">
                                <ul class="box-nav-ul d-flex align-items-center justify-content-center gap-30">
                                    <li class="menu-item">
                                        <a href="/" class="item-link">Home<i class="icon icon-arrow-down"></i></a>
                                    </li>
                                    <li class="menu-item">
                                        <a href="/shop" class="item-link">Shope<i class="icon icon-arrow-down"></i></a>
                                    </li>
                                    <li class="menu-item">
                                        <a href="#" class="item-link">About<i class="icon icon-arrow-down"></i></a>
                                    </li>
                                    <li class="menu-item">
                                        <a href="#" class="item-link">Contact<i class="icon icon-arrow-down"></i></a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        <div class="col-xl-3 col-md-4 col-3">
                            <ul class="nav-icon d-flex justify-content-end align-items-center gap-20">
                                <!-- Search Icon -->
                                <li class="nav-search">
                                    <a href="#canvasSearch" data-bs-toggle="offcanvas" aria-controls="offcanvasLeft"
                                        class="nav-icon-item">
                                        <i class="icon icon-search"></i>
                                    </a>
                                </li>

                               
                                <% if(locals.userData){ %>
                                   
                                    <li class="nav-logout">
                                        <form action="/logout" method="POST" class="nav-icon-item"
                                            style="display: inline;">
                                            <button type="submit" class="btn-logout"
                                                style="background: none; border: none; padding: 0; cursor: pointer;">
                                                <i class="icon icon-logout"></i> Logout
                                            </button>
                                        </form>
                                    </li>

                                    
                                    <li class="nav-user">
                                        <p class="mb-0">
                                            <%= locals.userData[0]?.firstName %>
                                        </p>
                                    </li>
                                    <% } else { %>
                                      
                                        <li class="nav-account">
                                            <a href="#login" data-bs-toggle="modal" class="nav-icon-item">
                                                <i class="icon icon-account"></i> Login
                                            </a>
                                        </li>
                                        <% } %>

                                            <!-- Wishlist Icon -->
                                            <li class="nav-wishlist">
                                                <a href="wishlist.html" class="nav-icon-item">
                                                    <i class="icon icon-heart"></i><span class="count-box">0</span>
                                                </a>
                                            </li>

                                            <!-- Cart Icon -->
                                            <li class="nav-cart">
                                                <a href="/cart" class="nav-icon-item">
                                                    <i class="icon icon-bag"></i><span class="count-box">0</span>
                                                </a>
                                            </li>
                            </ul>
                        </div>

                    </div>
                </div>

            </header>

            <div class="tf-page-title">
                <div class="container-full">
                    <div class="heading text-center">Check Out</div>
                </div>
            </div>
            <section class="py-5">
                <div class="px-5">
                    <div class="tf-page-cart-wrap layout-2">
                        <div>
                            <form id="checkoutForm" method="POST" action="/place-order">
                                <!-- Address Selection Section -->
                                <div id="addressCardContainer" class="mb-4 ">
                                    <div class="row row-cols-1 row-cols-md-2 g-4">
                                        <% address.forEach((data, index)=> { %>
                                            <div class="col" id="addressCard-<%= data._id %>">
                                                <div class="card h-100 shadow-sm">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <%= data.firstName %>
                                                                <%= data.lastName %>
                                                        </h6>
                                                        <address class="small mb-3">
                                                            <%= data.address %><br>
                                                                <%= data.city %>, <%= data.state %>
                                                                        <%= data.postal_code %>
                                                                            <br>
                                                                            <a href="tel:<%= data.phone %>"
                                                                                class="text-decoration-none">
                                                                                <%= data.phone %>
                                                                            </a>
                                                        </address>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="selectedAddress" id="address<%= index %>"
                                                                value="<%= data._id %>" <%=index===0 ? 'checked' : ''
                                                                %>>
                                                            <label class="form-check-label" for="address<%= index %>">
                                                                Use this address
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="adrs-btn">
                                                        <button type="button"
                                                            class="btn btn-primary btn-fill btn-icon animate-hover-btn btn-edit btn-dark"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#editModal-<%= data._id %>">
                                                            Edit Address
                                                        </button>
                                                        <button type="button"
                                                            class="btn btn-danger btn-fill btn-icon animate-hover-btn btn-delete"
                                                            data-id="<%= data._id %>">
                                                            Delete Address
                                                        </button>
                                                    </div>

                                                </div>

                                            </div>
                                            <% }) %>
                                    </div>
                                </div>
                                <div class="d-grid mb-4">
                                    <button type="button"
                                        class="btn btn-primary radius-3 btn-fill btn-icon animate-hover-btn w-50 "
                                        data-bs-toggle="modal" data-bs-target="#addressModal">
                                        Add New Address
                                    </button>
                                </div>

                                <!-- Payment Method Section -->
                                <h6 class="mb-3">Payment Method</h6>
                                <div class="mb-4">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="cod"
                                            value="COD" checked>
                                        <label class="form-check-label" for="cod">Cash on Delivery</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="razorpay"
                                            value="RAZORPAY">
                                        <label class="form-check-label" for="razorpay">Pay Online (Razorpay)</label>
                                    </div>
                                </div>

                                <!-- Order Total Section -->

                                <div class="d-flex justify-content-between align-items-center border-top pt-2 mb-3 w-50">
                                    <h6  class="mb-0">Subtotal</h6>
                                    <h6 class="mb-0">₹<span id="subtotal">
                                            <%= subTotal.toFixed(2) %>
                                        </span></h6>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2 w-50" id="discountRow"
                                    style="display: none !important;">
                                    <h6 class="mb-0">Discount</h6>
                                    <h6 class="mb-0 text-success ">-₹<span id="discountAmount">0.00</span></h6>
                                </div>
                                <div class="d-flex justify-content-between align-items-center border-top  pt-2 mb-3 w-50">
                                    <h6 class="mb-0">Total</h6>
                                    <h6 class="mb-0">₹<span id="total">
                                            <%= subTotal.toFixed(2) %>
                                        </span></h6>
                                </div>

                                <!-- Privacy Notice -->

                                <p class="text-muted small mb-4 w-50">
                                    Your personal data will be used to process your order,
                                   
                                    support your experience
                                    throughout this website, and for other purposes described in
                                    our
                                    <a href="/privacy-policy" class="text-decoration-underline">privacy policy</a>.
                                </p>

                                <!-- Place Order Button -->

                                <div class="d-grid">
                                    <button type="submit"
                                        class="btn btn-primary w-50 py-2 btn-fill btn-icon animate-hover-btn">
                                        Place order
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="tf-page-cart-footer px-5">
                            <div class="">
                                <div class="mb-4">
                                    <h6 class="mb-3">Apply Coupon</h6>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="couponCode" placeholder="Enter coupon code">
                                        <button class="btn btn-outline-secondary btn-fill btn-icon animate-hover-btn" type="button" id="applyCouponBtn">Apply</button>
                                    </div>
                                    <button class="btn btn-outline-secondary btn-fill btn-icon animate-hover-btn" type="button" id="showCouponsBtn">Available Coupons</button>

                                    <div id="couponMessage" class="mt-2"></div>
                                </div>
                                    <!-- Coupon Modal -->
                                <div id="couponModal" class="modal" style="display: none;">
                                    <div class="modal-content">
                                        <span class="close">&times;</span>
                                        <h6>Available Coupons</h6>
                                        <div id="availableCoupons"></div>
                                    </div>
                                </div>
                                <ul class="wrap-checkout-product">
                                    <%cart.items.forEach((item)=>{%>
                                        <li class="checkout-product-item ">
                                            <figure class="img-product" id="productCards">
                                                <img width="80px " height="80px"
                                                    src="/uploads/<%=item.productId.images[0]%>" alt="product">
                                                <span class="quantity">
                                                    <%=item.productId.productName%>
                                                </span>
                                                <span class="quantity">
                                                    <%=item.quantity%>
                                                </span>
                                                <span class="quantity">
                                                    <%=item.productId.price * item.quantity%>
                                                </span>
                                            </figure>

                                        </li>
                                        <%})%>
                                </ul>



                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Add Address Modal -->
            <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addressModalLabel">Add a new address
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Form Inside Modal -->
                            <form class="show-form-address wd-form-address" id="formnewAddress">
                                <div class="box-field grid-2-lg">
                                    <div class="tf-field style-1">
                                        <input class="tf-field-input tf-input" placeholder=" " type="text"
                                            id="firstname" name="first_name" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="firstname">First
                                            name</label>
                                    </div>
                                    <div class="tf-field style-1">
                                        <input class="tf-field-input tf-input" placeholder=" " type="text" id="lastname"
                                            name="last_name" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="lastname">Last name</label>
                                    </div>
                                </div>
                                <div class="box-field">
                                    <div class="tf-field style-1">
                                        <input class="tf-field-input tf-input" placeholder=" " type="text" id="address"
                                            name="address" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="address">Address</label>
                                    </div>
                                </div>
                                <div class="box-field">
                                    <div class="tf-field style-1">
                                        <input class="tf-field-input tf-input" placeholder=" " type="text" id="city"
                                            name="city" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="city">City</label>
                                    </div>
                                </div>
                                <div class="box-field">
                                    <label for="state" class="mb_10 fw-4 text-start d-block text_black-2">State</label>
                                    <div class="select-custom">
                                        <select class="tf-select w-100" id="state<%= address._id %>" name="state">
                                            <option value="---" data-cities="[]" <%=address.state==='---' ? 'selected'
                                                : '' %>>---</option>
                                            <option value="Andhra Pradesh"
                                                data-cities="[['Hyderabad','Hyderabad'],['Vijayawada','Vijayawada'],['Visakhapatnam','Visakhapatnam']]"
                                                <%=address.state==='Andhra Pradesh' ? 'selected' : '' %>>Andhra Pradesh
                                            </option>
                                            <option value="Arunachal Pradesh"
                                                data-cities="[['Itanagar','Itanagar'],['Tawang','Tawang'],['Bomdila','Bomdila']]"
                                                <%=address.state==='Arunachal Pradesh' ? 'selected' : '' %>>Arunachal
                                                Pradesh</option>
                                            <option value="Assam"
                                                data-cities="[['Guwahati','Guwahati'],['Dibrugarh','Dibrugarh'],['Silchar','Silchar']]"
                                                <%=address.state==='Assam' ? 'selected' : '' %>>Assam</option>
                                            <option value="Bihar"
                                                data-cities="[['Patna','Patna'],['Gaya','Gaya'],['Bhagalpur','Bhagalpur']]"
                                                <%=address.state==='Bihar' ? 'selected' : '' %>>Bihar</option>
                                            <option value="Chhattisgarh"
                                                data-cities="[['Raipur','Raipur'],['Bilaspur','Bilaspur'],['Korba','Korba']]"
                                                <%=address.state==='Chhattisgarh' ? 'selected' : '' %>>Chhattisgarh
                                            </option>
                                            <option value="Goa"
                                                data-cities="[['Panaji','Panaji'],['Margao','Margao'],['Vasco da Gama','Vasco da Gama']]"
                                                <%=address.state==='Goa' ? 'selected' : '' %>>Goa</option>
                                            <option value="Gujarat"
                                                data-cities="[['Ahmedabad','Ahmedabad'],['Surat','Surat'],['Vadodara','Vadodara']]"
                                                <%=address.state==='Gujarat' ? 'selected' : '' %>>Gujarat</option>
                                            <option value="Haryana"
                                                data-cities="[['Chandigarh','Chandigarh'],['Gurugram','Gurugram'],['Faridabad','Faridabad']]"
                                                <%=address.state==='Haryana' ? 'selected' : '' %>>Haryana</option>
                                            <option value="Himachal Pradesh"
                                                data-cities="[['Shimla','Shimla'],['Manali','Manali'],['Dharamshala','Dharamshala']]"
                                                <%=address.state==='Himachal Pradesh' ? 'selected' : '' %>>Himachal
                                                Pradesh
                                            </option>
                                            <option value="Jharkhand"
                                                data-cities="[['Ranchi','Ranchi'],['Jamshedpur','Jamshedpur'],['Dhanbad','Dhanbad']]"
                                                <%=address.state==='Jharkhand' ? 'selected' : '' %>>Jharkhand</option>
                                            <option value="Karnataka"
                                                data-cities="[['Bengaluru','Bengaluru'],['Mysuru','Mysuru'],['Hubli','Hubli']]"
                                                <%=address.state==='Karnataka' ? 'selected' : '' %>>Karnataka</option>
                                            <option value="Kerala"
                                                data-cities="[['Thiruvananthapuram','Thiruvananthapuram'],['Kochi','Kochi'],['Kozhikode','Kozhikode']]"
                                                <%=address.state==='Kerala' ? 'selected' : '' %>>Kerala</option>
                                            <option value="Madhya Pradesh"
                                                data-cities="[['Bhopal','Bhopal'],['Indore','Indore'],['Gwalior','Gwalior']]"
                                                <%=address.state==='Madhya Pradesh' ? 'selected' : '' %>>Madhya Pradesh
                                            </option>
                                            <option value="Maharashtra"
                                                data-cities="[['Mumbai','Mumbai'],['Pune','Pune'],['Nagpur','Nagpur']]"
                                                <%=address.state==='Maharashtra' ? 'selected' : '' %>>Maharashtra
                                            </option>
                                            <option value="Manipur"
                                                data-cities="[['Imphal','Imphal'],['Churachandpur','Churachandpur'],['Thoubal','Thoubal']]"
                                                <%=address.state==='Manipur' ? 'selected' : '' %>>Manipur</option>
                                            <option value="Meghalaya"
                                                data-cities="[['Shillong','Shillong'],['Tura','Tura'],['Jowai','Jowai']]"
                                                <%=address.state==='Meghalaya' ? 'selected' : '' %>>Meghalaya</option>
                                            <option value="Mizoram"
                                                data-cities="[['Aizawl','Aizawl'],['Lunglei','Lunglei'],['Champhai','Champhai']]"
                                                <%=address.state==='Mizoram' ? 'selected' : '' %>>Mizoram</option>
                                            <option value="Nagaland"
                                                data-cities="[['Kohima','Kohima'],['Dimapur','Dimapur'],['Mokokchung','Mokokchung']]"
                                                <%=address.state==='Nagaland' ? 'selected' : '' %>>Nagaland</option>
                                            <option value="Odisha"
                                                data-cities="[['Bhubaneswar','Bhubaneswar'],['Cuttack','Cuttack'],['Rourkela','Rourkela']]"
                                                <%=address.state==='Odisha' ? 'selected' : '' %>>Odisha</option>
                                            <option value="Punjab"
                                                data-cities="[['Chandigarh','Chandigarh'],['Amritsar','Amritsar'],['Ludhiana','Ludhiana']]"
                                                <%=address.state==='Punjab' ? 'selected' : '' %>>Punjab</option>
                                            <option value="Rajasthan"
                                                data-cities="[['Jaipur','Jaipur'],['Udaipur','Udaipur'],['Jodhpur','Jodhpur']]"
                                                <%=address.state==='Rajasthan' ? 'selected' : '' %>>Rajasthan</option>
                                            <option value="Sikkim"
                                                data-cities="[['Gangtok','Gangtok'],['Namchi','Namchi'],['Mangan','Mangan']]"
                                                <%=address.state==='Sikkim' ? 'selected' : '' %>>Sikkim</option>
                                            <option value="Tamil Nadu"
                                                data-cities="[['Chennai','Chennai'],['Coimbatore','Coimbatore'],['Madurai','Madurai']]"
                                                <%=address.state==='Tamil Nadu' ? 'selected' : '' %>>Tamil Nadu</option>
                                            <option value="Telangana"
                                                data-cities="[['Hyderabad','Hyderabad'],['Warangal','Warangal'],['Khammam','Khammam']]"
                                                <%=address.state==='Telangana' ? 'selected' : '' %>>Telangana</option>
                                            <option value="Tripura"
                                                data-cities="[['Agartala','Agartala'],['Udaipur','Udaipur'],['Kailashahar','Kailashahar']]"
                                                <%=address.state==='Tripura' ? 'selected' : '' %>>Tripura</option>
                                            <option value="Uttar Pradesh"
                                                data-cities="[['Lucknow','Lucknow'],['Kanpur','Kanpur'],['Varanasi','Varanasi']]"
                                                <%=address.state==='Uttar Pradesh' ? 'selected' : '' %>>Uttar Pradesh
                                            </option>
                                            <option value="Uttarakhand"
                                                data-cities="[['Dehradun','Dehradun'],['Haridwar','Haridwar'],['Nainital','Nainital']]"
                                                <%=address.state==='Uttarakhand' ? 'selected' : '' %>>Uttarakhand
                                            </option>
                                            <option value="West Bengal"
                                                data-cities="[['Kolkata','Kolkata'],['Siliguri','Siliguri'],['Howrah','Howrah']]"
                                                <%=address.state==='West Bengal' ? 'selected' : '' %>>West Bengal
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="box-field">
                                    <div class="tf-field style-1">
                                        <input class="tf-field-input tf-input" placeholder=" " type="text"
                                            id="postal_code" name="postal_code" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="postal_code">Postal
                                            Code</label>
                                    </div>
                                </div>
                                <div class="box-field">
                                    <div class="tf-field style-1">
                                        <input class="tf-field-input tf-input" placeholder=" " type="tel" id="phone"
                                            name="phone" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="phone">Phone</label>
                                    </div>
                                </div>
                                <div class="box-field">
                                    <button type="submit" class="btn btn-primary">Save
                                        address</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <% address.forEach((address)=> { %>
                <div class="modal fade" id="editModal-<%= address._id %>" tabindex="-1"
                    aria-labelledby="editAddressModalLabel" aria-hidden="true" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form class="editAddressForm" data-id="<%= address._id %>">
                                    <input type="hidden" id="addressId<%= address._id %>" name="address_id"
                                        value="<%= address._id %>">
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="editFirstName<%= address._id %>">First Name</label>
                                            <input type="text" class="form-control" id="editFirstName<%= address._id %>"
                                                name="first_name" value="<%= address.firstName %>" required>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="editLastName<%= address._id %>">Last Name</label>
                                            <input type="text" class="form-control" id="editLastName<%= address._id %>"
                                                name="last_name" value="<%= address.lastName %>" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="address<%= address._id %>">Address</label>
                                        <input type="text" class="form-control" id="address<%= address._id %>"
                                            name="address" value="<%= address.address %>" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="city<%= address._id %>">City</label>
                                        <input type="text" class="form-control" id="city<%= address._id %>" name="city"
                                            value="<%= address.city %>" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="state<%= address._id %>">State</label>
                                        <select class="tf-select w-100" id="state<%= address._id %>" name="state">
                                            <option value="---" data-cities="[]" <%=address.state==='---' ? 'selected'
                                                : '' %>>---</option>
                                            <option value="Andhra Pradesh"
                                                data-cities="[['Hyderabad','Hyderabad'],['Vijayawada','Vijayawada'],['Visakhapatnam','Visakhapatnam']]"
                                                <%=address.state==='Andhra Pradesh' ? 'selected' : '' %>
                                                >Andhra Pradesh
                                            </option>
                                            <option value="Arunachal Pradesh"
                                                data-cities="[['Itanagar','Itanagar'],['Tawang','Tawang'],['Bomdila','Bomdila']]"
                                                <%=address.state==='Arunachal Pradesh' ? 'selected' : '' %>
                                                >Arunachal
                                                Pradesh</option>
                                            <option value="Assam"
                                                data-cities="[['Guwahati','Guwahati'],['Dibrugarh','Dibrugarh'],['Silchar','Silchar']]"
                                                <%=address.state==='Assam' ? 'selected' : '' %>>Assam
                                            </option>
                                            <option value="Bihar"
                                                data-cities="[['Patna','Patna'],['Gaya','Gaya'],['Bhagalpur','Bhagalpur']]"
                                                <%=address.state==='Bihar' ? 'selected' : '' %>>Bihar
                                            </option>
                                            <option value="Chhattisgarh"
                                                data-cities="[['Raipur','Raipur'],['Bilaspur','Bilaspur'],['Korba','Korba']]"
                                                <%=address.state==='Chhattisgarh' ? 'selected' : '' %>
                                                >Chhattisgarh</option>
                                            <option value="Goa"
                                                data-cities="[['Panaji','Panaji'],['Margao','Margao'],['Vasco da Gama','Vasco da Gama']]"
                                                <%=address.state==='Goa' ? 'selected' : '' %>>Goa</option>
                                            <option value="Gujarat"
                                                data-cities="[['Ahmedabad','Ahmedabad'],['Surat','Surat'],['Vadodara','Vadodara']]"
                                                <%=address.state==='Gujarat' ? 'selected' : '' %>>Gujarat
                                            </option>
                                            <option value="Haryana"
                                                data-cities="[['Chandigarh','Chandigarh'],['Gurugram','Gurugram'],['Faridabad','Faridabad']]"
                                                <%=address.state==='Haryana' ? 'selected' : '' %>>Haryana
                                            </option>
                                            <option value="Himachal Pradesh"
                                                data-cities="[['Shimla','Shimla'],['Manali','Manali'],['Dharamshala','Dharamshala']]"
                                                <%=address.state==='Himachal Pradesh' ? 'selected' : '' %>
                                                >Himachal Pradesh
                                            </option>
                                            <option value="Jharkhand"
                                                data-cities="[['Ranchi','Ranchi'],['Jamshedpur','Jamshedpur'],['Dhanbad','Dhanbad']]"
                                                <%=address.state==='Jharkhand' ? 'selected' : '' %>
                                                >Jharkhand</option>
                                            <option value="Karnataka"
                                                data-cities="[['Bengaluru','Bengaluru'],['Mysuru','Mysuru'],['Hubli','Hubli']]"
                                                <%=address.state==='Karnataka' ? 'selected' : '' %>
                                                >Karnataka</option>
                                            <option value="Kerala"
                                                data-cities="[['Thiruvananthapuram','Thiruvananthapuram'],['Kochi','Kochi'],['Kozhikode','Kozhikode']]"
                                                <%=address.state==='Kerala' ? 'selected' : '' %>>Kerala
                                            </option>
                                            <option value="Madhya Pradesh"
                                                data-cities="[['Bhopal','Bhopal'],['Indore','Indore'],['Gwalior','Gwalior']]"
                                                <%=address.state==='Madhya Pradesh' ? 'selected' : '' %>
                                                >Madhya Pradesh
                                            </option>
                                            <option value="Maharashtra"
                                                data-cities="[['Mumbai','Mumbai'],['Pune','Pune'],['Nagpur','Nagpur']]"
                                                <%=address.state==='Maharashtra' ? 'selected' : '' %>
                                                >Maharashtra</option>
                                            <option value="Manipur"
                                                data-cities="[['Imphal','Imphal'],['Churachandpur','Churachandpur'],['Thoubal','Thoubal']]"
                                                <%=address.state==='Manipur' ? 'selected' : '' %>>Manipur
                                            </option>
                                            <option value="Meghalaya"
                                                data-cities="[['Shillong','Shillong'],['Tura','Tura'],['Jowai','Jowai']]"
                                                <%=address.state==='Meghalaya' ? 'selected' : '' %>
                                                >Meghalaya</option>
                                            <option value="Mizoram"
                                                data-cities="[['Aizawl','Aizawl'],['Lunglei','Lunglei'],['Champhai','Champhai']]"
                                                <%=address.state==='Mizoram' ? 'selected' : '' %>>Mizoram
                                            </option>
                                            <option value="Nagaland"
                                                data-cities="[['Kohima','Kohima'],['Dimapur','Dimapur'],['Mokokchung','Mokokchung']]"
                                                <%=address.state==='Nagaland' ? 'selected' : '' %>>Nagaland
                                            </option>
                                            <option value="Odisha"
                                                data-cities="[['Bhubaneswar','Bhubaneswar'],['Cuttack','Cuttack'],['Rourkela','Rourkela']]"
                                                <%=address.state==='Odisha' ? 'selected' : '' %>>Odisha
                                            </option>
                                            <option value="Punjab"
                                                data-cities="[['Chandigarh','Chandigarh'],['Amritsar','Amritsar'],['Ludhiana','Ludhiana']]"
                                                <%=address.state==='Punjab' ? 'selected' : '' %>>Punjab
                                            </option>
                                            <option value="Rajasthan"
                                                data-cities="[['Jaipur','Jaipur'],['Udaipur','Udaipur'],['Jodhpur','Jodhpur']]"
                                                <%=address.state==='Rajasthan' ? 'selected' : '' %>
                                                >Rajasthan</option>
                                            <option value="Sikkim"
                                                data-cities="[['Gangtok','Gangtok'],['Namchi','Namchi'],['Mangan','Mangan']]"
                                                <%=address.state==='Sikkim' ? 'selected' : '' %>>Sikkim
                                            </option>
                                            <option value="Tamil Nadu"
                                                data-cities="[['Chennai','Chennai'],['Coimbatore','Coimbatore'],['Madurai','Madurai']]"
                                                <%=address.state==='Tamil Nadu' ? 'selected' : '' %>>Tamil
                                                Nadu</option>
                                            <option value="Telangana"
                                                data-cities="[['Hyderabad','Hyderabad'],['Warangal','Warangal'],['Khammam','Khammam']]"
                                                <%=address.state==='Telangana' ? 'selected' : '' %>
                                                >Telangana</option>
                                            <option value="Tripura"
                                                data-cities="[['Agartala','Agartala'],['Udaipur','Udaipur'],['Kailashahar','Kailashahar']]"
                                                <%=address.state==='Tripura' ? 'selected' : '' %>>Tripura
                                            </option>
                                            <option value="Uttar Pradesh"
                                                data-cities="[['Lucknow','Lucknow'],['Kanpur','Kanpur'],['Varanasi','Varanasi']]"
                                                <%=address.state==='Uttar Pradesh' ? 'selected' : '' %>
                                                >Uttar Pradesh
                                            </option>
                                            <option value="Uttarakhand"
                                                data-cities="[['Dehradun','Dehradun'],['Haridwar','Haridwar'],['Nainital','Nainital']]"
                                                <%=address.state==='Uttarakhand' ? 'selected' : '' %>
                                                >Uttarakhand</option>
                                            <option value="West Bengal"
                                                data-cities="[['Kolkata','Kolkata'],['Siliguri','Siliguri'],['Howrah','Howrah']]"
                                                <%=address.state==='West Bengal' ? 'selected' : '' %>>West
                                                Bengal</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="postal_code<%= address._id %>">Postal Code</label>
                                        <input type="text" class="form-control" id="postal_code<%= address._id %>"
                                            name="postal_code" value="<%= address.postal_code %>" required
                                            pattern="[0-9]{6}">
                                    </div>
                                    <div class="form-group">
                                        <label for="phone<%= address._id %>">Phone</label>
                                        <input type="tel" class="form-control" id="phone<%= address._id %>" name="phone"
                                            value="<%= address.phone %>" required pattern="[0-9]{10}">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save changes</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <% }); %>






                    <footer id="footer" class="footer">
                        <div class="footer-wrap">
                            <div class="footer-body">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-xl-3 col-md-6 col-12">
                                            <div class="footer-infor">
                                                <div class="footer-logo">
                                                    <a href="index.html">
                                                        <img src="images/logo/logo.svg" alt="">
                                                    </a>
                                                </div>
                                                <ul>
                                                    <li>
                                                        <p>Address: 1234 Fashion Street, Suite 567, <br> New York, NY
                                                            10001</p>
                                                    </li>
                                                    <li>
                                                        <p>Email: <a href="#">info@fashionshop.com</a></p>
                                                    </li>
                                                    <li>
                                                        <p>Phone: <a href="#">(212) 555-1234</a></p>
                                                    </li>
                                                </ul>
                                                <ul class="tf-social-icon d-flex gap-10">
                                                    <li><a href="#"
                                                            class="box-icon w_34 round social-facebook border-line-black"><i
                                                                class="icon fs-14 icon-fb"></i></a></li>
                                                    <li><a href="#"
                                                            class="box-icon w_34 round social-twiter border-line-black"><i
                                                                class="icon fs-12 icon-Icon-x"></i></a></li>
                                                    <li><a href="#"
                                                            class="box-icon w_34 round social-instagram border-line-black"><i
                                                                class="icon fs-14 icon-instagram"></i></a></li>
                                                    <li><a href="#"
                                                            class="box-icon w_34 round social-tiktok border-line-black"><i
                                                                class="icon fs-14 icon-tiktok"></i></a></li>
                                                    <li><a href="#"
                                                            class="box-icon w_34 round social-pinterest border-line-black"><i
                                                                class="icon fs-14 icon-pinterest-1"></i></a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-xl-3 col-md-6 col-12 footer-col-block">
                                            <div class="footer-heading footer-heading-desktop">
                                                <h6>Help</h6>
                                            </div>

                                            <ul class="footer-menu-list tf-collapse-content">
                                                <li>
                                                    <a href="privacy-policy.html" class="footer-menu_item">Privacy
                                                        Policy</a>
                                                </li>
                                                <li>
                                                    <a href="delivery-return.html" class="footer-menu_item"> Returns +
                                                        Exchanges
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="shipping-delivery.html"
                                                        class="footer-menu_item">Shipping</a>
                                                </li>
                                                <li>
                                                    <a href="terms-conditions.html" class="footer-menu_item">Terms &amp;
                                                        Conditions</a>
                                                </li>
                                                <li>
                                                    <a href="faq-1.html" class="footer-menu_item">FAQ’s</a>
                                                </li>
                                                <li>
                                                    <a href="compare.html" class="footer-menu_item">Compare</a>
                                                </li>
                                                <li>
                                                    <a href="wishlist.html" class="footer-menu_item">My Wishlist</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="col-xl-3 col-md-6 col-12 footer-col-block">
                                            <div class="footer-heading footer-heading-desktop">
                                                <h6>About us</h6>
                                            </div>

                                            <ul class="footer-menu-list tf-collapse-content">
                                                <li>
                                                    <a href="about-us.html" class="footer-menu_item">Our Story</a>
                                                </li>
                                                <li>
                                                    <a href="our-store.html" class="footer-menu_item">Visit Our
                                                        Store</a>
                                                </li>
                                                <li>
                                                    <a href="contact-1.html" class="footer-menu_item">Contact Us</a>
                                                </li>
                                                <li>
                                                    <a href="login.html" class="footer-menu_item">Account</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="col-xl-3 col-md-6 col-12">
                                            <div class="footer-newsletter footer-col-block">

                                                <div class="footer-heading footer-heading-moblie">
                                                    <h6>Sign Up for Email</h6>
                                                </div>
                                                <div class="tf-collapse-content">
                                                    <div class="footer-menu_item">Sign up to get first dibs on new
                                                        arrivals,
                                                        sales,
                                                        exclusive content, events and more!</div>
                                                    <form class="form-newsletter" id="subscribe-form" action="#"
                                                        method="post" accept-charset="utf-8" data-mailchimp="true">
                                                        <div id="subscribe-content">
                                                            <fieldset class="email">
                                                                <input type="email" name="email-form"
                                                                    id="subscribe-email"
                                                                    placeholder="Enter your email...." tabindex="0"
                                                                    aria-required="true">
                                                            </fieldset>
                                                            <div class="button-submit">
                                                                <button id="subscribe-button"
                                                                    class="tf-btn btn-sm radius-3 btn-fill btn-icon animate-hover-btn"
                                                                    type="button">Subscribe<i
                                                                        class="icon icon-arrow1-top-left"></i></button>
                                                            </div>
                                                        </div>
                                                        <div id="subscribe-msg"></div>
                                                    </form>
                                                    <div class="tf-cur">
                                                        <div class="tf-currencies">
                                                            <div
                                                                class="dropdown bootstrap-select image-select center style-default type-currencies">
                                                                <select
                                                                    class="image-select center style-default type-currencies">
                                                                    <option data-thumbnail="images/country/fr.svg"
                                                                        data-content="<img src='images/country/fr.svg'/> EUR € | France">
                                                                        EUR € | France</option>
                                                                    <option data-thumbnail="images/country/de.svg"
                                                                        data-content="<img src='images/country/de.svg'/> EUR € | Germany">
                                                                        EUR € | Germany</option>
                                                                    <option selected=""
                                                                        data-thumbnail="images/country/us.svg"
                                                                        data-content="<img src='images/country/us.svg'/> USD $ | United States">
                                                                        USD $ | United States</option>
                                                                    <option data-thumbnail="images/country/vn.svg"
                                                                        data-content="<img src='images/country/vn.svg'/> VND ₫ | Vietnam">
                                                                        VND ₫ | Vietnam</option>
                                                                </select>

                                                                <div class="dropdown-menu ">
                                                                    <div class="inner show" role="listbox"
                                                                        id="bs-select-1" tabindex="-1">
                                                                        <ul class="dropdown-menu inner show"
                                                                            role="presentation">
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="tf-languages">
                                                            <div
                                                                class="dropdown bootstrap-select image-select center style-default type-languages">
                                                                <select
                                                                    class="image-select center style-default type-languages">
                                                                    <option>English</option>
                                                                    <option>العربية</option>
                                                                    <option>简体中文</option>
                                                                    <option>اردو</option>
                                                                </select>

                                                                <div class="dropdown-menu ">
                                                                    <div class="inner show" role="listbox"
                                                                        id="bs-select-2" tabindex="-1">
                                                                        <ul class="dropdown-menu inner show"
                                                                            role="presentation">
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="footer-bottom">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-12">
                                            <div
                                                class="footer-bottom-wrap d-flex gap-20 flex-wrap justify-content-between align-items-center">
                                                <div class="footer-menu_item">© 2024 Ecomus Store. All Rights Reserved
                                                </div>
                                                <div class="tf-payment">
                                                    <img src="images/payments/visa.png" alt="">
                                                    <img src="images/payments/img-1.png" alt="">
                                                    <img src="images/payments/img-2.png" alt="">
                                                    <img src="images/payments/img-3.png" alt="">
                                                    <img src="images/payments/img-4.png" alt="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </footer>



                    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
                    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const form = document.getElementById('formnewAddress');

                            form.addEventListener('submit', async function (e) {
                                e.preventDefault();

                                if (!validateForm()) {
                                    return;
                                }

                                // Create a formData object and convert it into a plain object
                                const formData = new FormData(form);
                                const data = Object.fromEntries(formData.entries());

                                try {
                                    // Send the address data to the server
                                    const response = await fetch('/addAddress', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify(data),
                                    });
                                    const result = await response.json();
                                    if (!response.ok) {
                                        throw new Error(result.error || 'Network response was not ok');
                                    }
                                    // Show success message
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success',
                                        text: 'Address added successfully',
                                    }).then(() => {
                                        location.reload()
                                    });

                                    // Clear form fields
                                    form.reset();
                                } catch (error) {
                                    console.error('Error:', error);
                                    // Show error message
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: error.message || 'There was a problem saving your address. Please try again.',
                                    });
                                }
                            });


                            function validateForm() {
                                const requiredFields = ['first_name', 'last_name', 'address', 'city', 'state', 'postal_code'];
                                let isValid = true;

                                requiredFields.forEach(fieldName => {
                                    const field = form.elements[fieldName];
                                    if (!field.value.trim()) {
                                        isValid = false;
                                        showFieldError(field, 'This field is required');
                                    } else {
                                        clearFieldError(field);
                                    }
                                });

                             
                                const phoneField = form.elements['phone'];
                                if (phoneField && phoneField.value.trim() && !isValidPhone(phoneField.value)) {
                                    isValid = false;
                                    showFieldError(phoneField, 'Please enter a valid phone number');
                                }

                                
                                const postalCodeField = form.elements['postal_code'];
                                if (!isValidPostalCode(postalCodeField.value)) {
                                    isValid = false;
                                    showFieldError(postalCodeField, 'Please enter 6 digit postal code');
                                }

                                return isValid;
                            }

                           
                            function isValidPhone(phone) {
                                const phoneRegex = /^\+?1?\s*\(?[2-9]\d{2}\)?[-.\s]?\d{3}[-.\s]?\d{4}$/;
                                return phoneRegex.test(phone);
                            }


                            function isValidPostalCode(postalCode) {
                                const postalCodeRegex = /^[1-9][0-9]{5}$/;
                                return postalCodeRegex.test(postalCode);
                            }


                            // Function to show field-specific error messages
                            function showFieldError(field, message) {
                                clearFieldError(field);
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'field-error text-danger';
                                errorDiv.textContent = message;
                                field.parentNode.insertBefore(errorDiv, field.nextSibling);
                                field.classList.add('is-invalid');
                            }

                            // Function to clear field-specific error messages
                            function clearFieldError(field) {
                                const existingError = field.parentNode.querySelector('.field-error');
                                if (existingError) {
                                    existingError.remove();
                                }
                                field.classList.remove('is-invalid');
                            }

                            // Function to display success or error messages
                            function showMessage(message, type) {

                                const existingAlert = document.querySelector('.alert');
                                if (existingAlert) existingAlert.remove();

                                const messageDiv = document.createElement('div');
                                messageDiv.className = `alert alert-${type}`;
                                messageDiv.textContent = message;

                                form.prepend(messageDiv);

                                setTimeout(() => {
                                    messageDiv.remove();
                                }, 3000);
                            }
                        });
                    </script>

                    <!-- EDIT ADDRESS -->
                    <script>
                        const editAddressForms = document.querySelectorAll('.editAddressForm');
                        editAddressForms.forEach((element) => {
                            element.addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const id = element.getAttribute('data-id');
                                const firstName = document.getElementById(`editFirstName${id}`);
                                const lastName = document.getElementById(`editLastName${id}`);
                                const address = document.getElementById(`address${id}`);
                                const city = document.getElementById(`city${id}`);
                                const state = document.getElementById(`state${id}`);
                                const postalCode = document.getElementById(`postal_code${id}`);
                                const phone = document.getElementById(`phone${id}`);


                                element.querySelectorAll('.error-message').forEach(el => el.remove());

                                // Validation
                                let isValid = true;

                                function showError(input, message) {
                                    isValid = false;
                                    const errorDiv = document.createElement('div');
                                    errorDiv.className = 'error-message';
                                    errorDiv.style.color = 'red';
                                    errorDiv.textContent = message;
                                    input.parentNode.insertBefore(errorDiv, input.nextSibling);
                                }

                                if (!firstName.value.trim() || firstName.value.trim().length < 2) {
                                    showError(firstName, "First name should be at least 2 characters long.");
                                }

                                if (!lastName.value.trim() || lastName.value.trim().length < 2) {
                                    showError(lastName, "Last name should be at least 2 characters long.");
                                }

                                if (!address.value.trim() || address.value.trim().length < 5) {
                                    showError(address, "Address should be at least 5 characters long.");
                                }

                                if (!city.value.trim() || city.value.trim().length < 2) {
                                    showError(city, "City should be at least 2 characters long.");
                                }

                                if (!state.value) {
                                    showError(state, "Please select a state.");
                                }

                                if (!postalCode.value.trim() || !/^[1-9][0-9]{5}$/.test(postalCode.value.trim())) {
                                    showError(postalCode, "Please enter a valid 6-digit PIN code.");
                                }

                                if (!phone.value.trim() || !/^[6-9]\d{9}$/.test(phone.value.trim())) {
                                    showError(phone, "Please enter a valid 10-digit mobile number.");
                                }

                                if (!isValid) {
                                    return;
                                }

                                const data = {
                                    firstName: firstName.value.trim(),
                                    lastName: lastName.value.trim(),
                                    address: address.value.trim(),
                                    city: city.value.trim(),
                                    state: state.value,
                                    postal_code: postalCode.value.trim(),
                                    phone: phone.value.trim()
                                };

                                try {
                                    const response = await fetch(`/editAddress/${id}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify(data),
                                    });

                                    const result = await response.json();

                                    if (!result.success) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Oops...',
                                            text: result.message
                                        });
                                        return;
                                    }

                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success',
                                        text: result.message
                                    }).then(() => {
                                        location.reload();
                                    });

                                } catch (error) {
                                    console.error('Error submitting form:', error);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'An error occurred. Please try again.'
                                    });
                                }
                            });
                        });
                    </script>

                    <script>
                        document.querySelectorAll('.btn-delete').forEach(button => {
                            button.addEventListener('click', function () {
                                const addressId = this.dataset.id;


                                Swal.fire({
                                    title: 'Are you sure?',
                                    text: "This action will permanently delete the address.",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: 'Yes, delete it!',
                                    cancelButtonText: 'No, keep it'
                                }).then((result) => {
                                    if (result.isConfirmed) {

                                        fetch(`/deleteAddress/${addressId}`, {
                                            method: 'DELETE',
                                        })
                                            .then(response => {
                                                if (response.ok) {
                                                    Swal.fire(
                                                        'Deleted!',
                                                        'The address has been deleted.',
                                                        'success'
                                                    );


                                                    document.querySelector(`#addressCard-${addressId}`).remove();
                                                } else {
                                                    Swal.fire('Error', 'Failed to delete the address.', 'error');
                                                }
                                            })
                                            .catch(error => console.error('Error:', error));
                                    }
                                });
                            });
                        });
                    </script>


                    <script>
                        document.getElementById('checkoutForm').addEventListener('submit', function (e) {
                            e.preventDefault();

                            const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
                            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');

                            if (!selectedAddress) {
                                alert('Please select a delivery address');
                                return;
                            }

                            const formData = {
                                addressId: selectedAddress.value,
                                paymentMethod: paymentMethod.value
                            };

                            fetch('/place-order', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(formData)
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        if (formData.paymentMethod === 'COD') {
                                            window.location.href = `/orderSummary/${data.orderId}`;
                                        } else if (formData.paymentMethod === 'RAZORPAY') {

                                            const options = {
                                                key: 'rzp_test_O3ME5jMYgYC8PP',
                                                amount: data.amount,
                                                currency: "INR",
                                                name: "Your Company Name",
                                                description: "Order Payment",
                                                order_id: data.razorpayOrderId,
                                                handler: function (response) {

                                                    fetch('/verify-payment', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json'
                                                        },
                                                        body: JSON.stringify({
                                                            orderId: data.orderId,
                                                            razorpay_payment_id: response.razorpay_payment_id,
                                                            razorpay_order_id: response.razorpay_order_id,
                                                            razorpay_signature: response.razorpay_signature
                                                        })
                                                    })
                                                        .then(response => response.json())
                                                        .then(data => {
                                                            if (data.success) {
                                                                window.location.href = `/orderSummary/${data.orderId}`;
                                                            } else {
                                                                alert(data.message);
                                                            }
                                                        })
                                                        .catch(error => {
                                                            console.error('Error:', error);
                                                            alert('An error occurred while verifying the payment');
                                                        });
                                                },
                                                prefill: {
                                                    name: "Customer Name",
                                                    email: "customer@example.com",
                                                    contact: "9999999999"
                                                },
                                                theme: {
                                                    color: "#fffff"
                                                }
                                            };
                                            const rzp1 = new Razorpay(options);
                                            rzp1.open();
                                        }
                                    } else {
                                        alert(data.message || 'An error occurred while placing the order');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert('An error occurred while placing the order');
                                });
                        });
                    </script>

                    <!-- COUPON -->

                    <script>
                      
                        document.getElementById('applyCouponBtn').addEventListener('click', function () {
                            const couponCode = document.getElementById('couponCode').value;
                            console.log(couponCode);
                            
                            fetch('/apply-coupon', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ couponCode }),
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        document.getElementById('couponMessage').innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                                        document.getElementById('discountRow').style.display = 'flex';
                                        document.getElementById('discountAmount').textContent = data.discountAmount.toFixed(2);
                                        document.getElementById('total').textContent = data.totalAfterDiscount.toFixed(2);
                                        document.getElementById('applyCouponBtn').textContent = 'Remove';
                                        document.getElementById('applyCouponBtn').classList.remove('btn-outline-secondary');
                                        document.getElementById('applyCouponBtn').classList.add('btn-outline-danger');
                                    } else {
                                        document.getElementById('couponMessage').innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    document.getElementById('couponMessage').innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
                                });
                        });

                        document.getElementById('applyCouponBtn').addEventListener('click', function () {
                            if (this.textContent === 'Remove') {
                                fetch('/remove-coupon', {
                                    method: 'POST',
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            document.getElementById('couponMessage').innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                                            document.getElementById('discountRow').style.display = 'none';
                                            document.getElementById('total').textContent = data.subTotal.toFixed(2);
                                            this.textContent = 'Apply';
                                            this.classList.remove('btn-outline-danger');
                                            this.classList.add('btn-outline-secondary');
                                            document.getElementById('couponCode').value = '';
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        document.getElementById('couponMessage').innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
                                    });
                            }
                        });

                        const availableCoupons = [
                <%coupon.forEach(coupon=>{%>            
        { code: '<%=coupon.couponId%>', description: '<%=coupon.discount%>% off your order' },
        <%})%>
    ];
    // COUPON MODAL...
    const modal = document.getElementById('couponModal');
    const showCouponsBtn = document.getElementById('showCouponsBtn');
    const closeBtn = document.getElementsByClassName('close')[0];
    const availableCouponsDiv = document.getElementById('availableCoupons');
    const couponCodeInput = document.getElementById('couponCode');
    const applyCouponBtn = document.getElementById('applyCouponBtn');
    const couponMessage = document.getElementById('couponMessage');

    // Show modal
    showCouponsBtn.onclick = function() {
        modal.style.display = 'block';
        displayAvailableCoupons();
    }

    // Close modal
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    // Close modal if clicked outside
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    function displayAvailableCoupons() {
        availableCouponsDiv.innerHTML = '';
        availableCoupons.forEach(coupon => {
            const couponElement = document.createElement('div');
            couponElement.innerHTML = `
                <p><strong>${coupon.code}</strong>: ${coupon.description}</p>
                <button onclick="copyCoupon('${coupon.code}')">Copy Code</button>
            `;
            availableCouponsDiv.appendChild(couponElement);
        });
    }

    function copyCoupon(code) {
        couponCodeInput.value = code;
        modal.style.display = 'none';
        couponMessage.textContent = `Coupon ${code} Applied!`;
    }

    applyCouponBtn.onclick = function() {
        const code = couponCodeInput.value;
        if (code) {
            
            couponMessage.textContent = `Coupon ${code} applied successfully!`;
        } else {
            couponMessage.textContent = 'Please enter a coupon code.';
        }
    }
                    </script>

                    <%- include('../user-layouts/footer.ejs') %>