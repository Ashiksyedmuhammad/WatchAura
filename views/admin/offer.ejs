<%- include('../admin-layouts/header.ejs') %>
    <style>
        .error-message {
            color: red;
            font-size: 0.875em;
            margin-top: 0.25em;
        }
    </style>

    </head>

    <body>
        <div class="container-scroller">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
                    <a class="sidebar-brand brand-logo" href="index.html"><img
                            src="/admin-assets/assets/images/logo.svg" alt="logo" /></a>
                    <a class="sidebar-brand brand-logo-mini" href="index.html"><img
                            src="/admin-assets/assets/images/logo-mini.svg" alt="logo" /></a>
                </div>
                <ul class="nav">
                    <li class="nav-item profile">
                        <div class="profile-desc">
                            <div class="profile-pic">
                                <div class="count-indicator">
                                    <img class="img-xs rounded-circle"
                                        src="/admin-assets/assets/images/faces/face15.jpg" alt="">
                                    <span class="count bg-success"></span>
                                </div>
                                <div class="profile-name">
                                    <h5 class="mb-0 font-weight-normal">ADMIN</h5>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Sidebar menu items -->
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="/admin/dashboard">
                            <span class="menu-icon">
                                <i class="mdi mdi-speedometer"></i>
                            </span>
                            <span class="menu-title">DASHBOARD</span>
                        </a>
                    </li>
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="/admin/product">
                            <span class="menu-icon">
                                <i class="mdi mdi-playlist-play"></i>
                            </span>
                            <span class="menu-title">PRODUCTS</span>
                        </a>
                    </li>
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="/admin/category">
                            <span class="menu-icon">
                                <i class="mdi mdi-table-large"></i>
                            </span>
                            <span class="menu-title">CATEGORIES</span>
                        </a>
                    </li>
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="#">
                            <span class="menu-icon">
                                <i class="mdi mdi-table-large"></i>
                            </span>
                            <span class="menu-title">ORDERS</span>
                        </a>
                    </li>
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="/admin/customers">
                            <span class="menu-icon">
                                <i class="mdi mdi-contacts"></i>
                            </span>
                            <span class="menu-title">CUSTOMERS</span>
                        </a>
                    </li>
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="/admin/coupon">
                            <span class="menu-icon">
                                <i class="mdi mdi-ticket-percent"></i>
                            </span>
                            <span class="menu-title">COUPONS</span>
                        </a>
                    </li>
                    <li class="nav-item menu-items">
                        <a class="nav-link" href="/admin/offer">
                            <span class="menu-icon">
                                <i class="fas fa-percent"></i>
                            </span>
                            <span class="menu-title">OFFERS</span>
                        </a>
                        <ul class="nav flex-column sub-menu" id="offerSubMenu" style="display: none; padding-left: 20px;">
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/product-offer">
                                    <span class="menu-title">Product Offer</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/category-offer">
                                    <span class="menu-title">Category Offer</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>

            <!-- Navbar -->
            <div class="container-xxl flex-grow-1 container-p-y">

                <!-- Product List Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">PRODUCT OFFERS</h5>
                        <div class="d-flex justify-content-between align-items-center row pt-4 gap-4 gap-md-0">
                            <div class="col-md-4 product_status"></div>
                            <div class="col-md-4 product_category"></div>
                            <div class="col-md-4 product_stock"></div>
                        </div>
                    </div>
                    <div class="card-datatable table-responsive">
                        <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
                            <div class="card-header d-flex border-top rounded-0 flex-wrap py-0 pb-5 pb-md-0">
                                <div class="me-5 ms-n2"></div>
                                <div class="d-flex justify-content-start justify-content-md-end align-items-baseline">
                                    <div class="dt-action-buttons d-flex align-items-start align-items-md-center justify-content-sm-center gap-4 pt-0">
                                        <div class="dt-buttons btn-group flex-wrap d-flex pt-4 pb-4">
                                            <button type="button" class="btn btn-primary waves-effect waves-light" data-bs-toggle="modal" data-bs-target="#addOffer">
                                                <span>
                                                    <i class="ri-add-line ri-16px me-0 me-sm-1_5"></i>
                                                    <span class="d-none d-sm-inline-block">Add Offer</span>
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
            
                            <!-- Offer Cards -->
                            <div class="row row-cols-1 row-cols-md-3 g-4 mb-6">
                                <% offers.forEach(offer => { %>
                                    <div class="col">
                                        <div class="offer-card card h-100">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <%= offer.title %>
                                                </h5>
                                                <div class="card-text">
                                                    <p class="description"><strong>Description:</strong> <%= offer.description %></p>
                                                    <p class="discount"><strong>Discount:</strong> <%= offer.discount %>%</p>
                                                    <p class="status"><strong>Status:</strong> <span class="status-badge <%= offer.status === 'active' ? 'active' : 'inactive' %>">
                                                        <%= offer.status %>
                                                    </span></p>
                                                    <p class="publish-date"><strong>Publish Date:</strong> <%= offer.createdAt.toLocaleDateString() %></p>
                                                </div>
                                                <a href="#" class="btn btn-primary waves-effect waves-light" data-bs-toggle="modal" data-bs-target="#editOffer<%= offer._id %>">
                                                    Edit <i class="icon-edit"></i>
                                                </a>
                                                <button class="btn btn-danger delete-offer waves-effect waves-light" data-offer-id="<%= offer._id %>">
                                                    Delete <i class="icon-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
            
                                    <!-- Edit Offer Modal -->
                                    <div class="modal fade" id="editOffer<%= offer._id %>" tabindex="-1" aria-labelledby="editOfferLabel<%= offer._id %>" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editOfferLabel<%= offer._id %>">Edit Offer</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form id="editOfferForm<%= offer._id %>" action="/admin/offers/edit/<%= offer._id %>" method="POST">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="offerTitle<%= offer._id %>" class="form-label">Offer Title</label>
                                                            <input type="text" class="form-control" id="offerTitle<%= offer._id %>" name="title" value="<%= offer.title %>" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="offerDescription<%= offer._id %>" class="form-label">Offer Description</label>
                                                            <textarea class="form-control" id="offerDescription<%= offer._id %>" name="description" rows="3" required><%= offer.description %></textarea>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="offerDiscount<%= offer._id %>" class="form-label">Discount (%)</label>
                                                            <input type="number" class="form-control" id="offerDiscount<%= offer._id %>" name="discount" value="<%= offer.discount %>" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="offerType<%= offer._id %>" class="form-label">Offer Type</label>
                                                            <select class="form-select" id="offerType<%= offer._id %>" name="type" required>
                                                                <option value="product" <%= offer.type === 'product' ? 'selected' : '' %>>Product</option>
                                                                <option value="category" <%= offer.type === 'category' ? 'selected' : '' %>>Category</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="applicableId<%= offer._id %>" class="form-label">Applicable ID</label>
                                                            <input type="text" class="form-control" id="applicableId<%= offer._id %>" name="applicableId" value="<%= offer.applicableId %>" placeholder="Enter Product/Category ID">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-primary">Update Offer</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
            
                                <% }) %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add Offer Modal -->
            <div class="modal fade" id="addOffer" tabindex="-1" aria-labelledby="addOfferLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addOfferLabel">Add New Offer</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="addOfferForm" action="/admin/offers/add" method="POST">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="offerTitle" class="form-label">Offer Title</label>
                                    <input type="text" class="form-control" id="offerTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="offerDescription" class="form-label">Offer Description</label>
                                    <textarea class="form-control" id="offerDescription" name="description" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="offerDiscount" class="form-label">Discount (%)</label>
                                    <input type="number" class="form-control" id="offerDiscount" name="discount" required>
                                </div>
                                <div class="mb-3">
                                    <label for="offerType" class="form-label">Offer Type</label>
                                    <select class="form-select" id="offerType" name="type" required>
                                        <option value="product">Product</option>
                                        <option value="category">Category</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="applicableId" class="form-label">Applicable ID</label>
                                    <input type="text" class="form-control" id="applicableId" name="applicableId" placeholder="Enter Product/Category ID">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Add Offer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>            
            <script>
                // Offer Management Script

document.addEventListener('DOMContentLoaded', function() {
    // Add Offer Form Submission
    const addOfferForm = document.getElementById('addOfferForm');
    if (addOfferForm) {
        addOfferForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(addOfferForm);
            fetch('/admin/offers/add', {
                method: 'POST',
                body: new URLSearchParams(formData),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the offer.');
            });
        });
    }

    // Edit Offer Form Submission
    document.querySelectorAll('[id^="editOfferForm"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const offerId = this.id.replace('editOfferForm', '');
            const formData = new FormData(this);
            fetch(`/admin/offers/edit/${offerId}`, {
                method: 'POST',
                body: new URLSearchParams(formData),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the offer.');
            });
        });
    });

    // Delete Offer
    document.querySelectorAll('.delete-offer').forEach(button => {
        button.addEventListener('click', function() {
            const offerId = this.getAttribute('data-offer-id');
            if (confirm('Are you sure you want to delete this offer?')) {
                fetch(`/admin/offers/delete/${offerId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the offer.');
                });
            }
        });
    });

    // Offer Type Change Handler
    const offerTypeSelects = document.querySelectorAll('[id^="offerType"]');
    offerTypeSelects.forEach(select => {
        select.addEventListener('change', function() {
            const form = this.closest('form');
            const applicableIdInput = form.querySelector('[id^="applicableId"]');
            if (this.value === 'referral') {
                applicableIdInput.disabled = true;
                applicableIdInput.value = '';
            } else {
                applicableIdInput.disabled = false;
            }
        });
    });
});
            </script>
    </body>

    <%- include('../admin-layouts/footer.ejs') %>